<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Wargame Map</title>

    <!-- Leaflet.js CSS for map styling -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <!-- Tailwind CSS for overall page styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrolling */
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        /* Styling for the unit name labels */
        .unit-label {
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            color: #1f2937; /* gray-800 */
            text-shadow: 0 0 2px white, 0 0 2px white, 0 0 2px white;
        }
        /* Styling for popups */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            font-size: 13px;
            line-height: 1.6;
        }
        .leaflet-popup-content b {
            color: #111827;
        }
        /* Style for draggable items in the menu */
        .draggable-unit {
            cursor: grab;
        }
        .draggable-unit:active {
            cursor: grabbing;
        }
        /* Targeting mode cursor */
        .targeting-cursor {
            cursor: crosshair !important;
        }
        /* Trajectory line style */
        .trajectory-line {
            stroke-dasharray: 5, 10;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Map Container -->
        <div id="map-container" class="relative flex-grow h-full">
            <div id="map"></div>
            <!-- Simulation Controls -->
            <div class="absolute top-4 left-4 z-[1000] bg-white p-2 rounded-lg shadow-lg flex flex-col space-y-2">
                <div class="flex space-x-2">
                    <button id="targeting-btn" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-gray-600 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Targeting Mode</button>
                    <button id="launch-btn" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Launch Missiles</button>
                </div>
                <div class="flex space-x-2">
                    <button id="save-btn" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save State</button>
                    <button id="reset-btn" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-orange-500 rounded-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-400">Reset Scene</button>
                    <button id="clear-btn" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Clear All</button>
                </div>
            </div>
        </div>

        <!-- Right Hand Menu -->
        <div class="w-80 h-full bg-white shadow-lg overflow-y-auto p-4 border-l border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Unit Palette</h2>
            <div id="unit-menu" class="space-y-4">
                <!-- Menu content will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Leaflet.js JavaScript library -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // --- GLOBAL STATE ---
        let isTargetingMode = false;
        let activeMissile = null;
        let targetedLaunches = [];
        let activeMapUnits = []; // Holds all active unit objects on the map
        let savedScenario = null; // Holds the saved state of the map
        const missileTypes = ['sa-10', 'sa-12', 'anti-ship', 'agm-258'];

        // --- MAP INITIALIZATION ---
        var map = L.map('map').setView([-6.3, 146.8], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- UNIT DATA LIBRARY ---
        const unitLibrary = {
            'sa-10': { name: 'SA-10 Shawshank', shortName: 'SA-10', force: 'red', category: 'weapons', iconUrl: 'https://cdn-icons-png.flaticon.com/512/7165/7165074.png', rangeRings: [{ rangeNm: 120, color: 'orange' }, { rangeNm: 70, color: 'gold' }, { rangeNm: 50, color: 'crimson' }], popup: "...", maxRange: 50 * 1852 },
            'sa-12': { name: 'SA-12 Sabot', shortName: 'SA-12', force: 'red', category: 'weapons', iconUrl: 'https://cdn-icons-png.flaticon.com/512/7165/7165074.png', rangeRings: [{ rangeNm: 300, color: 'green' }, { rangeNm: 140, color: 'limegreen' }, { rangeNm: 100, color: 'darkgreen' }], popup: "...", maxRange: 100 * 1852 },
            'anti-ship': { name: 'Anti-Ship Missile', shortName: 'CD Missile', force: 'red', category: 'weapons', iconUrl: 'https://cdn-icons-png.flaticon.com/512/2369/2369415.png', rangeRings: [{ rangeNm: 350, color: 'darkred' }], popup: "...", maxRange: 350 * 1852 },
            'marines': { name: 'Marines', shortName: 'Marines', force: 'red', category: 'land', iconUrl: 'https://cdn-icons-png.flaticon.com/512/9924/9924283.png', rangeRings: [{ rangeNm: 50, color: 'brown' }], popup: "..." },
            'y-12': { name: 'Y-12 Milo', shortName: 'Y-12', force: 'red', category: 'air', iconUrl: 'https://cdn-icons-png.flaticon.com/512/7893/7893970.png', rangeRings: [{ rangeNm: 200, color: 'purple' }, { rangeNm: 150, color: 'indigo' }, { rangeNm: 60, color: 'violet' }], popup: "..." },
            'agm-258': { name: 'AGM-258', shortName: 'AGM-258', force: 'blue', category: 'weapons', iconUrl: 'https://cdn-icons-png.flaticon.com/512/7165/7165074.png', rangeRings: [{ rangeNm: 100, color: 'darkblue' }], popup: "...", maxRange: 100 * 1852 },
            'blue-hq': { name: 'Blue Joint HQ', shortName: 'Joint HQ', force: 'blue', category: 'land', iconUrl: 'https://cdn-icons-png.flaticon.com/512/208/208379.png', rangeRings: [], popup: "..." },
            'wedge-snail': { name: 'Wedge-Snail', shortName: 'Wedge-Snail', force: 'blue', category: 'air', iconUrl: 'https://cdn-icons-png.flaticon.com/512/7893/7893970.png', rangeRings: [{ rangeNm: 2000, color: 'violet' }, { rangeNm: 150, color: 'purple' }], popup: "..." },
            'ea-30g': { name: 'EA-30G Fowler', shortName: 'EA-30G', force: 'blue', category: 'air', iconUrl: 'https://cdn-icons-png.flaticon.com/512/15631/15631307.png', rangeRings: [{ rangeNm: 1000, color: 'deepskyblue' }], popup: "..." },
            'f-55': { name: 'F-55 Flogger', shortName: 'F-55', force: 'blue', category: 'air', iconUrl: 'https://cdn-icons-png.flaticon.com/512/2089/2089910.png', rangeRings: [{ rangeNm: 800, color: 'lightblue' }, { rangeNm: 100, color: 'blue' }, { rangeNm: 50, color: 'darkblue' }], popup: "..." }
        };
        const impactIconUrl = 'https://cdn-icons-png.flaticon.com/512/3219/3219507.png';
        const missedIconUrl = 'https://cdn-icons-png.flaticon.com/512/14521/14521298.png';

        // --- ICON CREATION ---
        const createUrlIcon = (url, size = [32, 32]) => L.icon({ iconUrl: url, iconSize: size, iconAnchor: [size[0]/2, size[1]], popupAnchor: [0, -size[1]] });

        // --- CORE FUNCTION TO ADD UNITS TO MAP ---
        function addCapability(latlng, unitData, unitId) {
            if (!unitData) return;
            const icon = createUrlIcon(unitData.iconUrl);
            const marker = L.marker(latlng, { icon: icon, draggable: true }).addTo(map);
            
            marker.unitId = unitId;
            marker.unitData = unitData;
            marker.bindPopup(unitData.popup);

            const nameMarker = L.marker(latlng, { icon: L.divIcon({ className: 'unit-label', html: `<div>${unitData.shortName}</div>`, iconAnchor: [unitData.shortName.length * 3, -5] }), interactive: false }).addTo(map);
            
            const rangeCircles = unitData.rangeRings.map(range => {
                return L.circle(latlng, { radius: range.rangeNm * 1852, color: range.color, fillColor: range.color, fillOpacity: 0.1, weight: 2 }).addTo(map);
            });

            const unitObject = { marker, nameMarker, rangeCircles, unitId, unitData };
            activeMapUnits.push(unitObject);

            marker.on('drag', e => {
                if(isTargetingMode) return;
                nameMarker.setLatLng(e.latlng);
                rangeCircles.forEach(circle => circle.setLatLng(e.latlng));
            });

            if (missileTypes.includes(unitId)) {
                marker.on('click', () => {
                    if (isTargetingMode) {
                        if(activeMissile) activeMissile.getElement().style.filter = 'none';
                        activeMissile = marker;
                        marker.getElement().style.filter = 'drop-shadow(0 0 5px blue)';
                    }
                });
            }
            return unitObject;
        }

        // --- SIMULATION & TARGETING LOGIC ---
        const mapContainer = document.getElementById('map-container');
        const targetingBtn = document.getElementById('targeting-btn');
        const launchBtn = document.getElementById('launch-btn');
        const resetBtn = document.getElementById('reset-btn');
        const saveBtn = document.getElementById('save-btn');
        const clearBtn = document.getElementById('clear-btn');

        targetingBtn.addEventListener('click', () => {
            isTargetingMode = !isTargetingMode;
            if (isTargetingMode) {
                targetingBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                targetingBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                mapContainer.classList.add('targeting-cursor');
                targetingBtn.textContent = "Exit Targeting";
            } else {
                targetingBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                targetingBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                mapContainer.classList.remove('targeting-cursor');
                targetingBtn.textContent = "Targeting Mode";
                if(activeMissile) {
                    activeMissile.getElement().style.filter = 'none';
                    activeMissile = null;
                }
            }
        });

        map.on('click', (e) => {
            if (isTargetingMode && activeMissile) {
                const targetLatLng = e.latlng;
                const trajectoryLine = L.polyline([activeMissile.getLatLng(), targetLatLng], { color: 'red', weight: 2, className: 'trajectory-line' }).addTo(map);
                const unitObject = activeMapUnits.find(u => u.marker === activeMissile);
                targetedLaunches.push({ unitObject, target: targetLatLng, line: trajectoryLine });
                activeMissile.getElement().style.filter = 'none';
                activeMissile = null;
            }
        });

        function clearTargetingLines() {
            targetedLaunches.forEach(launch => launch.line.remove());
            targetedLaunches = [];
            if (activeMissile) {
                activeMissile.getElement().style.filter = 'none';
                activeMissile = null;
            }
        }

        launchBtn.addEventListener('click', () => {
            if(isTargetingMode) targetingBtn.click();
            targetedLaunches.forEach(animateMissile);
            targetedLaunches = [];
        });
        
        function animateMissile(launch) {
            const { unitObject, target } = launch;
            const { marker, nameMarker, rangeCircles, unitData } = unitObject;
            const startPoint = marker.getLatLng();
            const distanceToTarget = startPoint.distanceTo(target);
            const isHit = distanceToTarget <= unitData.maxRange;
            const endPoint = isHit ? target : getPointAtDistance(startPoint, target, unitData.maxRange);

            // Hide original
            marker.setOpacity(0);
            nameMarker.setOpacity(0);
            rangeCircles.forEach(c => c.setStyle({ opacity: 0, fillOpacity: 0 }));
            launch.line.remove();
            
            // Create flying clone
            const flyingMarker = L.marker(startPoint, { icon: createUrlIcon(unitData.iconUrl), draggable: false }).addTo(map);
            const flyingNameMarker = L.marker(startPoint, { icon: L.divIcon({className: 'unit-label', html: `<div>${unitData.shortName}</div>`}), interactive: false }).addTo(map);
            const flyingCircles = unitData.rangeRings.map(r => L.circle(startPoint, {radius: r.rangeNm * 1852, color: r.color, fillOpacity: 0.05, weight: 1}).addTo(map));

            const duration = 5000;
            const startTime = performance.now();

            function animationStep(now) {
                const progress = Math.min((now - startTime) / duration, 1);
                const currentLatLng = L.latLng(startPoint.lat + (endPoint.lat - startPoint.lat) * progress, startPoint.lng + (endPoint.lng - startPoint.lng) * progress);
                flyingMarker.setLatLng(currentLatLng);
                flyingNameMarker.setLatLng(currentLatLng);
                flyingCircles.forEach(c => c.setLatLng(currentLatLng));

                if (progress < 1) {
                    requestAnimationFrame(animationStep);
                } else {
                    [flyingMarker, flyingNameMarker, ...flyingCircles].forEach(item => item.remove());
                    const resultIcon = createUrlIcon(isHit ? impactIconUrl : missedIconUrl, [48, 48]);
                    const resultMarker = L.marker(endPoint, { icon: resultIcon }).addTo(map);

                    setTimeout(() => {
                        resultMarker.remove();
                        if (isHit) {
                            const index = activeMapUnits.findIndex(u => u.marker === marker);
                            if (index > -1) activeMapUnits.splice(index, 1);
                            [marker, nameMarker, ...rangeCircles].forEach(item => item.remove());
                        } else {
                            marker.setOpacity(1);
                            nameMarker.setOpacity(1);
                            rangeCircles.forEach(c => c.setStyle({ opacity: 1, fillOpacity: 0.1 }));
                        }
                    }, 2000);
                }
            }
            requestAnimationFrame(animationStep);
        }

        function getPointAtDistance(start, end, distance) {
            const totalDist = map.distance(start, end);
            if (distance >= totalDist) return end;
            const ratio = distance / totalDist;
            return L.latLng(start.lat + (end.lat - start.lat) * ratio, start.lng + (end.lng - start.lng) * ratio);
        }

        // --- SCENE MANAGEMENT ---
        function clearMap() {
            activeMapUnits.forEach(unit => {
                unit.marker.remove();
                unit.nameMarker.remove();
                unit.rangeCircles.forEach(c => c.remove());
            });
            activeMapUnits = [];
            clearTargetingLines();
        }

        saveBtn.addEventListener('click', () => {
            savedScenario = activeMapUnits.map(unit => ({
                latlng: unit.marker.getLatLng(),
                unitId: unit.unitId
            }));
            // Visual feedback
            saveBtn.textContent = "Saved!";
            saveBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            saveBtn.classList.add('bg-green-500');
            setTimeout(() => {
                saveBtn.textContent = "Save State";
                saveBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                saveBtn.classList.remove('bg-green-500');
            }, 1500);
        });

        resetBtn.addEventListener('click', () => {
            clearMap();
            if (savedScenario) {
                savedScenario.forEach(unit => addCapability(unit.latlng, unitLibrary[unit.unitId], unit.unitId));
            } else {
                setupInitialScene();
            }
        });
        
        clearBtn.addEventListener('click', clearMap);

        // --- DRAG AND DROP & MENU LOGIC ---
        const mapDropContainer = document.getElementById('map');
        mapDropContainer.addEventListener('dragover', e => e.preventDefault());
        mapDropContainer.addEventListener('drop', e => {
            e.preventDefault();
            const unitId = e.dataTransfer.getData('text/plain');
            const unitData = unitLibrary[unitId];
            if (!unitData) return;
            const mapRect = mapDropContainer.getBoundingClientRect();
            const x = e.clientX - mapRect.left;
            const y = e.clientY - mapRect.top;
            const latLng = map.containerPointToLatLng([x, y]);
            addCapability(latLng, unitData, unitId);
        });
        function populateMenu() {
            const menu = document.getElementById('unit-menu');
            const forces = {
                red: { name: 'Red Force', color: 'red-600', categories: { weapons: [], land: [], air: [], maritime: [] } },
                blue: { name: 'Blue Force', color: 'blue-600', categories: { weapons: [], land: [], air: [], maritime: [] } }
            };
            for (const unitId in unitLibrary) {
                const unit = unitLibrary[unitId];
                if (forces[unit.force] && forces[unit.force].categories[unit.category]) {
                    forces[unit.force].categories[unit.category].push({ id: unitId, ...unit });
                }
            }
            Object.values(forces).forEach(force => {
                const forceElement = document.createElement('details');
                forceElement.className = 'group';
                forceElement.open = true;
                let forceHtml = `<summary class="flex justify-between items-center font-semibold cursor-pointer text-lg text-${force.color} p-2 rounded-md bg-gray-50 hover:bg-gray-100">${force.name}<svg class="w-5 h-5 group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg></summary><div class="pl-2 pt-2 space-y-3">`;
                const categoryNames = { weapons: 'Weapons', land: 'Land Force', air: 'Air Force', maritime: 'Maritime Force' };
                Object.entries(categoryNames).forEach(([catKey, catName]) => {
                    const units = force.categories[catKey];
                    if (units.length > 0) {
                        forceHtml += `<h4 class="font-semibold text-gray-600 text-sm border-b pb-1">${catName}</h4><div class="space-y-2 pl-2">`;
                        units.forEach(unit => {
                            forceHtml += `<div class="draggable-unit flex items-center p-2 rounded-md hover:bg-gray-200 transition-colors" draggable="true" data-unit-id="${unit.id}"><img src="${unit.iconUrl}" class="w-6 h-6 mr-3"><span class="text-sm text-gray-700">${unit.name}</span></div>`;
                        });
                        forceHtml += `</div>`;
                    }
                });
                forceHtml += `</div>`;
                forceElement.innerHTML = forceHtml;
                menu.appendChild(forceElement);
            });
            document.querySelectorAll('.draggable-unit').forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', e.target.closest('.draggable-unit').dataset.unitId);
                    e.dataTransfer.effectAllowed = 'copy';
                });
            });
        }
        function setupInitialScene() {
            let startLatRed = -4.2, startLonRed = 152.2;
            let startLatBlue = -16.9, startLonBlue = 145.8;
            addCapability([startLatRed, startLonRed], unitLibrary['sa-10'], 'sa-10');
            addCapability([startLatRed + 0.2, startLonRed + 0.2], unitLibrary['sa-12'], 'sa-12');
            for (let i = 0; i < 4; i++) addCapability([startLatRed + 0.2 * i, startLonRed - 0.3 * i], unitLibrary['anti-ship'], 'anti-ship');
            for (let i = 0; i < 4; i++) addCapability([startLatRed + 0.1 * i, startLonRed + 0.3 * i], unitLibrary['marines'], 'marines');
            for (let i = 0; i < 3; i++) addCapability([startLatRed - 0.1 * i, startLonRed - 0.2 * i], unitLibrary['y-12'], 'y-12');
            addCapability([startLatBlue, startLonBlue], unitLibrary['blue-hq'], 'blue-hq');
            for (let i = 0; i < 4; i++) addCapability([startLatBlue + 0.1 * i, startLonBlue + 0.1 * i], unitLibrary['f-55'], 'f-55');
            for (let i = 0; i < 8; i++) addCapability([startLatBlue - 0.1 * i, startLonBlue + 0.2 * i], unitLibrary['agm-258'], 'agm-258');
            for (let i = 0; i < 2; i++) addCapability([startLatBlue + 0.2 * i, startLonBlue - 0.1 * i], unitLibrary['wedge-snail'], 'wedge-snail');
            for (let i = 0; i < 3; i++) addCapability([startLatBlue - 0.2 * i, startLonBlue - 0.2 * i], unitLibrary['ea-30g'], 'ea-30g');
        }

        // --- RUN ---
        populateMenu();
        setupInitialScene();
    </script>
</body>
</html>
