<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Wargame Map</title>

    <!-- Leaflet.js CSS for map styling -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>

    <!-- Tailwind CSS for overall page styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrolling */
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 100%;
            width: 100%;
            background-color: #a2d3f5; /* A light blue to represent the sea/sky */
        }
        /* Styling for the unit name labels */
        .unit-label {
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            color: #1f2937; /* gray-800 */
            text-shadow: 0 0 2px white, 0 0 2px white, 0 0 2px white;
        }
        /* Styling for popups */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            font-size: 13px;
            line-height: 1.6;
            margin: 10px 12px;
        }
        .leaflet-popup-content b {
            color: #111827;
        }
        /* Style for draggable items in the menu */
        .draggable-unit {
            cursor: grab;
        }
        .draggable-unit:active {
            cursor: grabbing;
        }
        /* Style for mountable ordnance in the menu */
        .mountable-ordnance {
            background-color: #eef2ff; /* indigo-50 */
        }
        /* Targeting mode cursor */
        .targeting-cursor {
            cursor: crosshair !important;
        }
        /* Trajectory line style */
        .trajectory-line {
            stroke-dasharray: 5, 10;
        }
        /* Aircraft weapon badge */
        .weapon-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            background-color: #ef4444; /* red-500 */
            color: white;
            border-radius: 9999px;
            width: 18px;
            height: 18px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid white;
        }
        /* Highlight for valid drop target */
        .drop-target-highlight {
            filter: drop-shadow(0 0 8px #22c55e) !important; /* green-500 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Map Container -->
        <div id="map-container" class="relative flex-grow h-full">
            <div id="map"></div>
            <!-- Simulation Controls -->
            <div class="absolute top-4 left-4 z-[1000] bg-white p-2 rounded-lg shadow-lg flex flex-col space-y-2">
                <div class="flex space-x-2">
                    <button id="targeting-btn" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-gray-600 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Targeting Mode</button>
                    <button id="launch-btn" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Launch Missiles</button>
                </div>
                <div class="flex space-x-2">
                    <button id="save-btn" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save State</button>
                    <button id="reset-btn" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-orange-500 rounded-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-400">Reset Scene</button>
                    <button id="clear-btn" class="flex-1 px-3 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Clear All</button>
                </div>
            </div>
        </div>

        <!-- Right Hand Menu -->
        <div class="w-80 h-full bg-white shadow-lg overflow-y-auto p-4 border-l border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Unit Palette</h2>
            <div id="unit-menu" class="space-y-4">
                <!-- Menu content will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Leaflet.js JavaScript library -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>

    <script>
        // --- GLOBAL STATE ---
        var isTargetingMode = false;
        var activeLaunch = null;
        var targetedLaunches = [];
        var activeMapUnits = [];
        var savedScenario = null;
        var nextUnitInstanceId = 0;
        var missileTypes = ['sa-10', 'sa-12', 'anti-ship', 'agm-258', 'meteor'];

        // --- MAP INITIALIZATION ---
        var map = L.map('map').setView([-6.3, 146.8], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- UNIT DATA LIBRARY ---
        var unitLibrary = {
            // Red Force
            'sa-10': { name: 'SA-10 Shawshank', shortName: 'SA-10', force: 'red', category: 'weapons', iconUrl: 'https://cdn-icons-png.flaticon.com/512/7165/7165074.png', rangeRings: [{ rangeNm: 120, color: 'orange' }, { rangeNm: 70, color: 'gold' }, { rangeNm: 50, color: 'crimson' }], maxRange: 50 * 1852, ammo: 4 },
            'sa-12': { name: 'SA-12 Sabot', shortName: 'SA-12', force: 'red', category: 'weapons', iconUrl: 'https://cdn-icons-png.flaticon.com/512/7165/7165074.png', rangeRings: [{ rangeNm: 300, color: 'green' }, { rangeNm: 140, color: 'limegreen' }, { rangeNm: 100, color: 'darkgreen' }], maxRange: 100 * 1852, ammo: 4 },
            'anti-ship': { name: 'Anti-Ship Missile', shortName: 'CD Missile', force: 'red', category: 'weapons', iconUrl: 'https://cdn-icons-png.flaticon.com/512/2369/2369415.png', rangeRings: [{ rangeNm: 350, color: 'darkred' }], maxRange: 350 * 1852, ammo: 2 },
            'marines': { name: 'Marines', shortName: 'Marines', force: 'red', category: 'land', iconUrl: 'https://cdn-icons-png.flaticon.com/512/9924/9924283.png', rangeRings: [{ rangeNm: 50, color: 'brown' }] },
            'y-12': { name: 'Y-12 Milo', shortName: 'Y-12', force: 'red', category: 'air', platformType: 'air', iconUrl: 'https://cdn-icons-png.flaticon.com/512/7893/7893970.png', rangeRings: [{ rangeNm: 200, color: 'purple' }, { rangeNm: 150, color: 'indigo' }, { rangeNm: 60, color: 'violet' }], hardpoints: 2 },
            
            // Blue Force
            'agm-258': { name: 'AGM-258 JASSM', shortName: 'JASSM', force: 'blue', category: 'weapons', platform: 'aircraft', iconUrl: 'https://cdn-icons-png.flaticon.com/512/7165/7165074.png', rangeRings: [{ rangeNm: 200, color: 'darkblue' }], maxRange: 200 * 1852, ammo: 1 },
            'meteor': { name: 'Meteor BVRAAM', shortName: 'Meteor', force: 'blue', category: 'weapons', platform: 'aircraft', iconUrl: 'https://cdn-icons-png.flaticon.com/512/2369/2369415.png', rangeRings: [{ rangeNm: 100, color: 'cyan' }], maxRange: 100 * 1852, ammo: 1 },
            'blue-hq': { name: 'Blue Joint HQ', shortName: 'Joint HQ', force: 'blue', category: 'land', iconUrl: 'https://cdn-icons-png.flaticon.com/512/208/208379.png', rangeRings: [] },
            'wedge-snail': { name: 'Wedge-Snail', shortName: 'Wedge-Snail', force: 'blue', category: 'air', platformType: 'air', iconUrl: 'https://cdn-icons-png.flaticon.com/512/7893/7893970.png', rangeRings: [{ rangeNm: 2000, color: 'violet' }, { rangeNm: 150, color: 'purple' }], hardpoints: 4 },
            'ea-30g': { name: 'EA-30G Fowler', shortName: 'EA-30G', force: 'blue', category: 'air', platformType: 'air', iconUrl: 'https://cdn-icons-png.flaticon.com/512/15631/15631307.png', rangeRings: [{ rangeNm: 1000, color: 'deepskyblue' }], hardpoints: 4 },
            'f-55': { name: 'F-55 Flogger', shortName: 'F-55', force: 'blue', category: 'air', platformType: 'air', iconUrl: 'https://cdn-icons-png.flaticon.com/512/2089/2089910.png', rangeRings: [{ rangeNm: 800, color: 'lightblue' }, { rangeNm: 100, color: 'blue' }, { rangeNm: 50, color: 'darkblue' }], hardpoints: 6 }
        };
        var impactIconUrl = 'https://cdn-icons-png.flaticon.com/512/3219/3219507.png';
        var missedIconUrl = 'https://cdn-icons-png.flaticon.com/512/14521/14521298.png';

        // --- ICON CREATION ---
        var createUrlIcon = function(url, size) {
            size = size || [32, 32];
            return L.icon({ iconUrl: url, iconSize: size, iconAnchor: [size[0]/2, size[1]], popupAnchor: [0, -size[1]] });
        };
        
        function createAircraftIcon(unitData, weaponCount) {
            var badgeHtml = weaponCount > 0 ? '<div class="weapon-badge">' + weaponCount + '</div>' : '';
            return L.divIcon({
                className: 'custom-div-icon',
                html: '<div style="position: relative;">' +
                           '<img src="' + unitData.iconUrl + '" style="width: 32px; height: 32px;">' +
                           badgeHtml +
                       '</div>',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
        }


        // --- CORE UNIT MANAGEMENT ---
        function addCapability(latlng, unitData, unitId, instanceId, ammo, mountedWeapons) {
            if (!unitData) return;

            instanceId = instanceId !== null ? instanceId : nextUnitInstanceId++;
            
            var icon;
            if (unitData.platformType === 'air') {
                var initialWeaponCount = mountedWeapons ? mountedWeapons.length : 0;
                icon = createAircraftIcon(unitData, initialWeaponCount);
            } else {
                icon = createUrlIcon(unitData.iconUrl);
            }

            var marker = L.marker(latlng, { icon: icon, draggable: true }).addTo(map);

            marker.unitId = unitId;
            marker.instanceId = instanceId;
            marker.unitData = unitData;

            var nameMarker = L.marker(latlng, { icon: L.divIcon({ className: 'unit-label', html: '<div>' + unitData.shortName + '</div>', iconAnchor: [unitData.shortName.length * 3, -5] }), interactive: false }).addTo(map);

            var rangeCircles = unitData.rangeRings.map(function(range) {
                return L.circle(latlng, { radius: range.rangeNm * 1852, color: range.color, fillColor: range.color, fillOpacity: 0.1, weight: 2 }).addTo(map);
            });

            var unitObject = {
                marker: marker,
                nameMarker: nameMarker,
                rangeCircles: rangeCircles,
                unitId: unitId,
                unitData: unitData,
                instanceId: instanceId,
                ammo: ammo !== null ? ammo : unitData.ammo,
                mountedWeapons: mountedWeapons ? mountedWeapons.map(function(w) { return Object.assign({}, w, { rangeCircles: [] }); }) : (unitData.hardpoints ? [] : null)
            };
            activeMapUnits.push(unitObject);
            
            if (unitObject.mountedWeapons) {
                unitObject.mountedWeapons.forEach(function(weapon) {
                    var weaponData = unitLibrary[weapon.weaponId];
                    weapon.rangeCircles = weaponData.rangeRings.map(function(r) {
                        return L.circle(latlng, { radius: r.rangeNm * 1852, color: r.color, fillColor: r.color, fillOpacity: 0.05, weight: 1, dashArray: '5, 5' }).addTo(map);
                    });
                });
            }

            updateUnitPopup(unitObject);

            marker.on('drag', function(e) {
                if(isTargetingMode) return;
                var currentLatLng = e.latlng;
                nameMarker.setLatLng(currentLatLng);
                rangeCircles.forEach(function(circle) { circle.setLatLng(currentLatLng); });
                if (unitObject.mountedWeapons) {
                    unitObject.mountedWeapons.forEach(function(w) {
                        w.rangeCircles.forEach(function(c) { c.setLatLng(currentLatLng); });
                    });
                }
            });

            marker.on('click', function() {
                if (isTargetingMode) {
                    if (!unitData.platformType && unitObject.ammo > 0) {
                        if(activeLaunch) activeLaunch.unitObject.marker.getElement().style.filter = '';
                        activeLaunch = { unitObject: unitObject, weapon: null };
                        marker.getElement().style.filter = 'drop-shadow(0 0 5px blue)';
                    }
                }
            });
            
            // Add drag-drop listeners for aircraft
            if (unitData.platformType === 'air') {
                marker.getElement().addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    marker.getElement().classList.add('drop-target-highlight');
                });
                marker.getElement().addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    marker.getElement().classList.remove('drop-target-highlight');
                });
                marker.getElement().addEventListener('dragover', function(e) {
                    e.preventDefault(); // Necessary to allow drop
                });
                marker.getElement().addEventListener('drop', function(e) {
                    e.preventDefault();
                    marker.getElement().classList.remove('drop-target-highlight');
                    var weaponId = e.dataTransfer.getData('text/plain');
                    mountWeaponOnAircraft(unitObject, weaponId);
                });
            }

            return unitObject;
        }

        function deleteUnit(instanceId) {
            var index = -1;
            for(var i = 0; i < activeMapUnits.length; i++) {
                if (activeMapUnits[i].instanceId === instanceId) {
                    index = i;
                    break;
                }
            }

            if (index > -1) {
                var unitToRemove = activeMapUnits.splice(index, 1)[0];
                unitToRemove.marker.remove();
                unitToRemove.nameMarker.remove();
                unitToRemove.rangeCircles.forEach(function(c) { c.remove(); });
                if (unitToRemove.mountedWeapons) {
                    unitToRemove.mountedWeapons.forEach(function(w) {
                        w.rangeCircles.forEach(function(c) { c.remove(); });
                    });
                }
            }
        }
        
        function updateUnitPopup(unitObject) {
            var popupContent = 
                '<div class="space-y-2">' +
                    '<h3 class="text-base font-bold text-gray-800">' + unitObject.unitData.name + '</h3>' +
                    '<p><b>Force:</b> <span class="capitalize ' + (unitObject.unitData.force === 'red' ? 'text-red-600' : 'text-blue-600') + '">' + unitObject.unitData.force + '</span></p>';

            if (unitObject.unitData.platformType === 'air') {
                popupContent += '<p><b>Hardpoints:</b> ' + unitObject.mountedWeapons.length + ' / ' + unitObject.unitData.hardpoints + '</p>';
                popupContent += '<div class="border-t pt-2 mt-2 space-y-1">';
                if (unitObject.mountedWeapons.length > 0) {
                    unitObject.mountedWeapons.forEach(function(weapon) {
                        var weaponData = unitLibrary[weapon.weaponId];
                        popupContent += '<div class="flex justify-between items-center text-sm">' +
                            '<span>' + weaponData.shortName + ' (Ammo: ' + weapon.ammo + ')</span>' +
                            '<div>' + 
                                '<button class="text-xs text-white bg-blue-600 hover:bg-blue-700 rounded px-2 py-1 mr-1" onclick="activateWeaponTargeting(' + unitObject.instanceId + ', ' + weapon.instanceId + ')">Target</button>' +
                                '<button class="text-xs text-white bg-red-600 hover:bg-red-700 rounded px-2 py-1" onclick="unmountWeaponFromAircraft(' + unitObject.instanceId + ', ' + weapon.instanceId + ')">X</button>' +
                            '</div>' +
                         '</div>';
                    });
                } else {
                    popupContent += '<p class="text-sm text-gray-500">No weapons mounted.</p>';
                }
                popupContent += '</div>';
            } else { 
                 if (unitObject.unitData.ammo !== undefined) {
                    popupContent += '<p><b>Ammo:</b> <span id="ammo-count-' + unitObject.instanceId + '">' + unitObject.ammo + '</span></p>';
                 }
            }

            popupContent += '<button onclick="deleteUnit(' + unitObject.instanceId + ')" class="mt-2 w-full px-3 py-1 text-sm text-white bg-red-600 rounded-md hover:bg-red-700">Delete</button></div>';
            unitObject.marker.bindPopup(popupContent);
        }

        // --- AIRCRAFT LOADOUT LOGIC ---
        function mountWeaponOnAircraft(aircraft, weaponUnitId) {
            var weaponData = unitLibrary[weaponUnitId];
            if (!aircraft || !weaponData || weaponData.platform !== 'aircraft' || aircraft.unitData.force !== weaponData.force) return;
            if (aircraft.mountedWeapons.length >= aircraft.unitData.hardpoints) return;
            
            var newWeapon = {
                weaponId: weaponUnitId,
                ammo: weaponData.ammo,
                instanceId: nextUnitInstanceId++,
                rangeCircles: []
            };

            var aircraftLatLng = aircraft.marker.getLatLng();
            newWeapon.rangeCircles = weaponData.rangeRings.map(function(r) {
                return L.circle(aircraftLatLng, { radius: r.rangeNm * 1852, color: r.color, fillColor: r.color, fillOpacity: 0.05, weight: 1, dashArray: '5, 5' }).addTo(map);
            });

            aircraft.mountedWeapons.push(newWeapon);
            
            aircraft.marker.setIcon(createAircraftIcon(aircraft.unitData, aircraft.mountedWeapons.length));
            updateUnitPopup(aircraft);
        }
        
        function unmountWeaponFromAircraft(aircraftInstanceId, weaponInstanceId) {
            var aircraft = activeMapUnits.find(function(u) { return u.instanceId === aircraftInstanceId; });
            if (!aircraft) return;

            var weaponIndex = -1;
            for(var i = 0; i < aircraft.mountedWeapons.length; i++) {
                if(aircraft.mountedWeapons[i].instanceId === weaponInstanceId) {
                    weaponIndex = i;
                    break;
                }
            }

            if (weaponIndex > -1) {
                var removedWeapon = aircraft.mountedWeapons.splice(weaponIndex, 1)[0];
                removedWeapon.rangeCircles.forEach(function(c) { c.remove(); });
                
                aircraft.marker.setIcon(createAircraftIcon(aircraft.unitData, aircraft.mountedWeapons.length));
                updateUnitPopup(aircraft);
                aircraft.marker.openPopup(); // Re-open popup to see the change
            }
        }

        // --- SIMULATION & TARGETING LOGIC ---
        function activateWeaponTargeting(aircraftInstanceId, weaponInstanceId) {
            if (!isTargetingMode) {
                document.getElementById('targeting-btn').click();
            }
            var aircraft = activeMapUnits.find(function(u) { return u.instanceId === aircraftInstanceId; });
            var weapon = aircraft.mountedWeapons.find(function(w) { return w.instanceId === weaponInstanceId; });
            
            if (aircraft && weapon) {
                if(activeLaunch) activeLaunch.unitObject.marker.getElement().style.filter = '';
                activeLaunch = { unitObject: aircraft, weapon: weapon };
                aircraft.marker.getElement().style.filter = 'drop-shadow(0 0 5px blue)';
                aircraft.marker.closePopup();
            }
        }

        function animateMissile(launch) {
            var isAircraftLaunch = !!launch.weapon;
            var launcher = launch.unitObject;
            var weaponInstance = isAircraftLaunch ? launch.weapon : launcher;
            var weaponData = isAircraftLaunch ? unitLibrary[launch.weapon.weaponId] : launcher.unitData;

            weaponInstance.ammo--;
            updateUnitPopup(launcher);

            var startPoint = launcher.marker.getLatLng();
            var distanceToTarget = startPoint.distanceTo(launch.target);
            var isHit = distanceToTarget <= weaponData.maxRange;
            var endPoint = isHit ? launch.target : getPointAtDistance(startPoint, launch.target, weaponData.maxRange);

            launch.line.remove();

            var flyingMarker = L.marker(startPoint, { icon: createUrlIcon(weaponData.iconUrl), draggable: false }).addTo(map);
            var duration = 3000;
            var startTime = performance.now();

            function animationStep(now) {
                var progress = Math.min((now - startTime) / duration, 1);
                var currentLatLng = L.latLng(startPoint.lat + (endPoint.lat - startPoint.lat) * progress, startPoint.lng + (endPoint.lng - startPoint.lng) * progress);
                flyingMarker.setLatLng(currentLatLng);

                if (progress < 1) {
                    requestAnimationFrame(animationStep);
                } else {
                    flyingMarker.remove();
                    var resultIcon = createUrlIcon(isHit ? impactIconUrl : missedIconUrl, [48, 48]);
                    var resultMarker = L.marker(endPoint, { icon: resultIcon }).addTo(map);

                    setTimeout(function() {
                        resultMarker.remove();
                        if (weaponInstance.ammo <= 0) {
                            if (isAircraftLaunch) {
                                unmountWeaponFromAircraft(launcher.instanceId, weaponInstance.instanceId);
                            } else {
                                deleteUnit(launcher.instanceId);
                            }
                        }
                    }, 2000);
                }
            }
            requestAnimationFrame(animationStep);
        }

        function getPointAtDistance(start, end, distance) {
            var totalDist = map.distance(start, end);
            if (distance >= totalDist) return end;
            var ratio = distance / totalDist;
            return L.latLng(start.lat + (end.lat - start.lat) * ratio, start.lng + (end.lng - start.lng) * ratio);
        }

        // --- SCENE MANAGEMENT ---
        function clearMap() {
            activeMapUnits.forEach(function(unit) {
                unit.marker.remove();
                unit.nameMarker.remove();
                unit.rangeCircles.forEach(function(c) { c.remove(); });
                if (unit.mountedWeapons) {
                    unit.mountedWeapons.forEach(function(w) {
                        w.rangeCircles.forEach(function(c) { c.remove(); });
                    });
                }
            });
            activeMapUnits = [];
        }

        function populateMenu() {
            var menu = document.getElementById('unit-menu');
            menu.innerHTML = '';
            var forces = {
                red: { name: 'Red Force', color: 'red-600', categories: { weapons: [], land: [], air: [], maritime: [], ordnance: [] } },
                blue: { name: 'Blue Force', color: 'blue-600', categories: { weapons: [], land: [], air: [], maritime: [], ordnance: [] } }
            };
            for (var unitId in unitLibrary) {
                if (Object.prototype.hasOwnProperty.call(unitLibrary, unitId)) {
                    var unit = unitLibrary[unitId];
                    var category = unit.platform === 'aircraft' ? 'ordnance' : unit.category;
                    if (forces[unit.force] && forces[unit.force].categories[category]) {
                        forces[unit.force].categories[category].push(Object.assign({ id: unitId }, unit));
                    }
                }
            }

            Object.keys(forces).forEach(function(forceKey) {
                var force = forces[forceKey];
                var forceElement = document.createElement('details');
                forceElement.className = 'group';
                forceElement.open = true;
                var forceHtml = '<summary class="flex justify-between items-center font-semibold cursor-pointer text-lg text-' + force.color + ' p-2 rounded-md bg-gray-50 hover:bg-gray-100">' + force.name + '<svg class="w-5 h-5 group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg></summary><div class="pl-2 pt-2 space-y-3">';
                var categoryNames = { weapons: 'Weapons Platforms', land: 'Land Force', air: 'Air Force', maritime: 'Maritime Force', ordnance: 'Ordnance' };
                
                for (var catKey in categoryNames) {
                    if (Object.prototype.hasOwnProperty.call(categoryNames, catKey)) {
                        var catName = categoryNames[catKey];
                        var units = force.categories[catKey];
                        if (units.length > 0) {
                            forceHtml += '<h4 class="font-semibold text-gray-600 text-sm border-b pb-1">' + catName + '</h4><div class="space-y-2 pl-2">';
                            units.forEach(function(unit) {
                                var isOrdnance = unit.platform === 'aircraft';
                                var divClass = 'draggable-unit flex items-center p-2 rounded-md hover:bg-gray-200 transition-colors' + (isOrdnance ? ' mountable-ordnance' : '');
                                forceHtml += '<div class="' + divClass + '" draggable="true" data-unit-id="' + unit.id + '"><img src="' + unit.iconUrl + '" class="w-6 h-6 mr-3"><span class="text-sm text-gray-700">' + unit.name + '</span></div>';
                            });
                            forceHtml += '</div>';
                        }
                    }
                }
                forceHtml += '</div>';
                forceElement.innerHTML = forceHtml;
                menu.appendChild(forceElement);
            });

            document.querySelectorAll('.draggable-unit').forEach(function(item) {
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', e.target.closest('.draggable-unit').dataset.unitId);
                    e.dataTransfer.effectAllowed = 'copy';
                });
            });
        }

        function setupInitialScene() {
            clearMap();
            var startLatRed = -4.2, startLonRed = 152.2;
            var startLatBlue = -16.9, startLonBlue = 145.8;
            addCapability(L.latLng(startLatRed, startLonRed), unitLibrary['sa-10'], 'sa-10');
            addCapability(L.latLng(startLatRed + 0.2, startLonRed + 0.2), unitLibrary['sa-12'], 'sa-12');
            for (var i = 0; i < 4; i++) addCapability(L.latLng(startLatRed + 0.2 * i, startLonRed - 0.3 * i), unitLibrary['anti-ship'], 'anti-ship');
            for (var i = 0; i < 4; i++) addCapability(L.latLng(startLatRed + 0.1 * i, startLonRed + 0.3 * i), unitLibrary['marines'], 'marines');
            for (var i = 0; i < 3; i++) addCapability(L.latLng(startLatRed - 0.1 * i, startLonRed - 0.2 * i), unitLibrary['y-12'], 'y-12');
            addCapability(L.latLng(startLatBlue, startLonBlue), unitLibrary['blue-hq'], 'blue-hq');
            for (var i = 0; i < 4; i++) addCapability(L.latLng(startLatBlue + 0.1 * i, startLonBlue + 0.1 * i), unitLibrary['f-55'], 'f-55');
            for (var i = 0; i < 2; i++) addCapability(L.latLng(startLatBlue + 0.2 * i, startLonBlue - 0.1 * i), unitLibrary['wedge-snail'], 'wedge-snail');
            for (var i = 0; i < 3; i++) addCapability(L.latLng(startLatBlue - 0.2 * i, startLonBlue - 0.2 * i), unitLibrary['ea-30g'], 'ea-30g');
        }
        
        // --- APPLICATION INITIALIZER ---
        function initializeApp() {
            var targetingBtn = document.getElementById('targeting-btn');
            var launchBtn = document.getElementById('launch-btn');
            var saveBtn = document.getElementById('save-btn');
            var resetBtn = document.getElementById('reset-btn');
            var clearBtn = document.getElementById('clear-btn');
            var mapDropContainer = document.getElementById('map');

            targetingBtn.addEventListener('click', function() {
                isTargetingMode = !isTargetingMode;
                targetingBtn.textContent = isTargetingMode ? "Exit Targeting" : "Targeting Mode";
                targetingBtn.classList.toggle('bg-gray-600');
                targetingBtn.classList.toggle('hover:bg-gray-700');
                targetingBtn.classList.toggle('bg-blue-600');
                targetingBtn.classList.toggle('hover:bg-blue-700');
                document.getElementById('map-container').classList.toggle('targeting-cursor');

                if (!isTargetingMode && activeLaunch) {
                    activeLaunch.unitObject.marker.getElement().style.filter = '';
                    activeLaunch = null;
                }
            });

            launchBtn.addEventListener('click', function() {
                if(isTargetingMode) targetingBtn.click();
                targetedLaunches.forEach(animateMissile);
                targetedLaunches = [];
            });

            saveBtn.addEventListener('click', function() {
                savedScenario = activeMapUnits.map(function(unit) {
                    return {
                        latlng: unit.marker.getLatLng(),
                        unitId: unit.unitId,
                        instanceId: unit.instanceId,
                        ammo: unit.ammo,
                        mountedWeapons: unit.mountedWeapons ? unit.mountedWeapons.map(function(w) { return { weaponId: w.weaponId, ammo: w.ammo, instanceId: w.instanceId }; }) : null
                    };
                });
                saveBtn.textContent = "Saved!";
                saveBtn.classList.replace('bg-indigo-600', 'bg-green-500');
                saveBtn.classList.remove('hover:bg-indigo-700');
                setTimeout(function() {
                    saveBtn.textContent = "Save State";
                    saveBtn.classList.replace('bg-green-500', 'bg-indigo-600');
                    saveBtn.classList.add('hover:bg-indigo-700');
                }, 1500);
            });

            resetBtn.addEventListener('click', function() {
                clearMap();
                if (savedScenario) {
                    savedScenario.forEach(function(unit) {
                        addCapability(unit.latlng, unitLibrary[unit.unitId], unit.unitId, unit.instanceId, unit.ammo, unit.mountedWeapons);
                    });
                } else {
                    setupInitialScene();
                }
            });
            
            clearBtn.addEventListener('click', clearMap);
            
            mapDropContainer.addEventListener('dragover', function(e) { e.preventDefault(); });
            mapDropContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                var unitId = e.dataTransfer.getData('text/plain');
                var unitData = unitLibrary[unitId];
                if (!unitData || unitData.platform === 'aircraft') return;
                var mapRect = mapDropContainer.getBoundingClientRect();
                var latLng = map.containerPointToLatLng([e.clientX - mapRect.left, e.clientY - mapRect.top]);
                addCapability(latLng, unitData, unitId);
            });

            map.on('click', function(e) {
                if (isTargetingMode && activeLaunch) {
                    var targetLatLng = e.latlng;
                    var trajectoryLine = L.polyline([activeLaunch.unitObject.marker.getLatLng(), targetLatLng], { color: 'red', weight: 2, className: 'trajectory-line' }).addTo(map);
                    
                    // FIX: Replaced Object.assign with a manual object creation for full compatibility.
                    var newLaunch = {
                        unitObject: activeLaunch.unitObject,
                        weapon: activeLaunch.weapon,
                        target: targetLatLng,
                        line: trajectoryLine
                    };
                    targetedLaunches.push(newLaunch);
                    
                    activeLaunch.unitObject.marker.getElement().style.filter = '';
                    activeLaunch = null;
                }
            });

            // --- STARTUP ---
            populateMenu();
            setupInitialScene();
        }

        // Run the app initializer once the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
